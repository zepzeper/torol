# Transformers Documentation

Transformers are methods chained onto the `Pipeline` class. Each transformer takes the data, modifies it in some way, and passes it along to the next step in the pipeline. All transformations are processed lazily, one row at a time.

---

## `map(callable $callback)`

Transforms each row by applying a callback function. The callback receives a `Row` object and should return the modified `Row`.

**Example:**
```php
$pipeline->map(function (Row $row) {
    return $row->set('name', strtoupper($row->get('name')));
});
```

## `filter(callable $callback)`

Filters the pipeline, keeping only the rows for which the callback returns a `true`-equivalent value.

**Example:**
```php
$pipeline->filter(function (Row $row) {
    return $row->get('status') === 'active';
});
```

## `addColumn(string $key, callable $callback)`

Adds a new column to each row. The value is generated by the callback function which receives the `Row` object.

**Example:**
```php
// Add a timestamp to each row
$pipeline->addColumn('processed_at', fn(Row $row) => date('Y-m-d H:i:s'));

// Add a computed column based on existing data
$pipeline->addColumn('full_name', fn(Row $row) => $row->get('first_name') . ' ' . $row->get('last_name'));
```

## `removeColumn(string|array $columns)`

Removes one or more columns from each row.

**Example:**
```php
// Remove a single column
$pipeline->removeColumn('password');

// Remove multiple columns
$pipeline->removeColumn(['password', 'temp_token']);
```

## `renameColumn(string $from, string $to)`

Renames a column in each row.

**Example:**
```php
$pipeline->renameColumn('user_email', 'email');
```

## `select(string|array $columns)`

Selects only the specified columns, discarding all others.

**Example:**
```php
// Select multiple columns as array
$pipeline->select(['id', 'name', 'email']);

// Select single column as string
$pipeline->select('name');
```

## `cast(string $key, string $type)`

Casts the value of a specific column to a different type.

**Supported types:** `'int'`, `'integer'`, `'string'`, `'bool'`, `'boolean'`, `'float'`, `'double'`

**Example:**
```php
// Cast age to integer
$pipeline->cast('age', 'int');

// Cast active status to boolean
$pipeline->cast('is_active', 'bool');
```

## `unique(string $key)`

Removes duplicate rows based on the value of a specific column.

**Example:**
```php
// Keep only one row for each unique email address
$pipeline->unique('email');
```

## `when(callable $condition, callable $transformer)`

Conditionally applies a transformation only to rows that meet a specific condition.

**Example:**
```php
$pipeline->when(
    fn(Row $row) => $row->get('age') >= 18,
    fn(Row $row) => $row->set('category', 'adult')
);
```

## `nest(string $key, array $columnsToNest)`

Nests a list of columns into a new sub-array under a single key.

**Example:**
```php
// Nest address-related columns
$pipeline->nest('address', ['street', 'city', 'zip_code']);
```

## `sort(string $key, string|int $direction = SORT_ASC)`

Sorts the entire dataset by a specific column. **Warning:** This method will load all data into memory and break the row-by-row streaming process. Use with caution on large datasets.

**Parameters:**
- `$key`: The column to sort by
- `$direction`: Either `SORT_ASC`, `SORT_DESC`, `'ASC'`, or `'DESC'`

**Example:**
```php
// Sort by name, alphabetically (ascending)
$pipeline->sort('name');

// Sort by age, descending
$pipeline->sort('age', SORT_DESC);

// Using string direction
$pipeline->sort('created_at', 'DESC');
```

## `groupBy(string $key)`

Groups rows by the value of a specific column. **Warning:** This is a memory-intensive operation that consumes the iterator.

**Returns:** `array<string, array<Row>>` - An associative array where keys are the unique values from the column and values are arrays of Row objects.

**Example:**
```php
// Groups users by their country
$groups = $pipeline->groupBy('country');
// Result: ['USA' => [Row, Row, ...], 'Canada' => [Row, Row, ...]]
```

## `merge(ExtractorInterface $extractor, string $localKey, string $foreignKey)`

Merges data from a secondary source into the main pipeline (like a LEFT JOIN).

**Example:**
```php
$pipeline->merge($userDetailsExtractor, 'user_id', 'id');
```

## `reduce(callable $reducer, mixed $initialValue = null)`

Reduces the pipeline to a single value using a reducer function.

**Example:**
```php
// Sum all ages
$totalAge = $pipeline->reduce(
    fn($accumulator, Row $row) => $accumulator + $row->get('age'),
    0
);

// Count active users
$activeCount = $pipeline->reduce(
    fn($count, Row $row) => $row->get('status') === 'active' ? $count + 1 : $count,
    0
);
```

## `take(int $limit)`

Takes the first `$limit` rows and stops processing.

**Example:**
```php
// Take only the first 10 rows
$pipeline->take(10);
```

## `takeWhile(callable $condition)`

Takes rows while the condition is true, stops at the first row that doesn't match.

**Example:**
```php
// Take rows while age is less than 30
$pipeline->takeWhile(fn(Row $row) => $row->get('age') < 30);
```

## `validate(callable $callback)`

Validates each row using a callback. This is essentially an alias for `filter()` - rows that don't pass validation are filtered out.

**Example:**
```php
$pipeline->validate(function (Row $row) {
    return !empty($row->get('email')) && filter_var($row->get('email'), FILTER_VALIDATE_EMAIL);
});
```

## `tap(callable $callback)`

"Taps" into the pipeline to perform an action on each row without modifying it (e.g., logging, debugging).

**Example:**
```php
$pipeline->tap(function (Row $row) {
    error_log('Processing user: ' . $row->get('name'));
});
```

## `dd()`

"Dump and Die". A debugging helper that dumps the current state of the pipeline and terminates the script.

**Example:**
```php
$pipeline
    ->map(fn(Row $row) => $row->set('name', strtoupper($row->get('name'))))
    ->dd(); // Dumps the result of the map operation and exits
```

## `get()`

Returns the current iterator as a `Traversable` object.

**Example:**
```php
foreach ($pipeline->get() as $row) {
    // Process each row
}
```

## `load(LoaderInterface $loader)`

Loads the processed data using a loader implementation and returns statistics about the operation.

**Returns:** `Stats` - An object containing processing statistics.

**Example:**
```php
$stats = $pipeline->load($csvLoader);
echo "Processed {$stats->getRowsProcessed()} rows";
```

## `onError(callable $handler)`

Sets an error handler for the pipeline. If not set, exceptions will be thrown normally.

**Example:**
```php
$pipeline->onError(function (Throwable $e, Row $row) {
    error_log("Error processing row: " . $e->getMessage());
    // Continue processing other rows
});
```
